<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
       ">

    <context:annotation-config />
	<!-- Turn on Spring's autoproxy using AspectJ's @Aspect annotations. -->
	<aop:aspectj-autoproxy />

	<import resource="classpath:concept-dao-beans.spb.xml" />
	<import resource="classpath:dao-beans.spb.xml" />
	<import resource="classpath:aws-topic-publisher.spb.xml" />
	<import resource="classpath:dynamo-dao-spb.xml" />

	<!-- The real Node DAO -->
	<bean id="nodeManager" class="org.sagebionetworks.repo.manager.NodeManagerImpl" />
	<bean id="nodeInheritanceManager"
		class="org.sagebionetworks.repo.manager.NodeInheritanceManagerImpl" />

	<!-- The Entity manager -->
	<bean id="entityManager" class="org.sagebionetworks.repo.manager.EntityManagerImpl" />

	<!-- Activity manager -->
	<bean id="activityManager" class="org.sagebionetworks.repo.manager.ActivityManagerImpl" />

	<!-- Trash manager -->
	<bean id="trashManager" class="org.sagebionetworks.repo.manager.trash.TrashManagerImpl" />

	<!-- Fixed Memory Pool - Used to provided a fix amount of memory used for transfering files
	      from http input streams to S3 -->
	<bean id="fileTransferFixedMemoryPool" class="org.sagebionetworks.repo.util.FixedMemoryPool" init-method="initialize">
	    <!-- This first argument controls the maximum memory used by the pool -->
	    <property name="maxMemoryBytes" ref="stackConfiguration.maxFileTransferMemoryPoolBytes"/>
	    <property name="blockSizeBytes" ref="stackConfiguration.fileTransferBufferSizeBytes"/>
	</bean>
	
	<!-- Memory File Transfer Strategy -->
	<bean id="memoryTransferStrategy" class="org.sagebionetworks.repo.manager.file.transfer.MemoryTransferStrategy" />
	
	<!-- Temp file provider -->
	<bean id="tempFileProvider" class="org.sagebionetworks.repo.util.TempFileProviderImpl" />
	
	<!-- Temp File Transfer Strategy -->
	<bean id="tempFileTransferStrategy" class="org.sagebionetworks.repo.manager.file.transfer.TempFileTransferStrategy" />
	
	<!-- File Upload manager -->
	<bean id="fileHandleManager" class="org.sagebionetworks.repo.manager.file.FileHandleManagerImpl" init-method="initialize" >
	    <!-- The memory strategy is the primary -->
	    <property name="primaryStrategy" ref="memoryTransferStrategy"/>
	   	<!-- The temp strategy is the fall-back -->
	    <property name="fallbackStrategy" ref="tempFileTransferStrategy"/>
	</bean>
	
	<!-- The preview manager -->
	<bean id="previewManager" class="org.sagebionetworks.repo.manager.file.preview.PreviewManagerImpl" init-method="initialize">
	    <!-- The list of preview generators-->
	    <property name="generatorList">
	        <list>
	            <bean id="imagePreviewGenerator" class="org.sagebionetworks.repo.manager.file.preview.ImagePreviewGenerator" />
	            <bean id="textPreviewGenerator" class="org.sagebionetworks.repo.manager.file.preview.TextPreviewGenerator" />
	            <bean id="zipPreviewGenerator" class="org.sagebionetworks.repo.manager.file.preview.ZipPreviewGenerator" />
	        </list>
	    </property>
	    <!-- The maximum amount of memory to uses -->
	   	<property name="maxPreviewMemory" ref="stackConfiguration.maxFilePreviewMemoryPoolBytes"/>
	</bean>
	
	<!-- The Location helper -->
	<bean id="locationHelper" class="org.sagebionetworks.repo.util.LocationHelpersImpl" />

	<bean id="referenceUtil" class="org.sagebionetworks.repo.util.ReferenceUtilImpl" />

	<bean id="authorizationManager"
		class="org.sagebionetworks.repo.manager.AuthorizationManagerImpl" />

	<bean id="permissionsManager" class="org.sagebionetworks.repo.manager.PermissionsManagerImpl" />

	<bean id="userProfileManager" class="org.sagebionetworks.repo.manager.UserProfileManagerImpl" />

	<bean id="accessRequirementManager" class="org.sagebionetworks.repo.manager.AccessRequirementManagerImpl" />

	<bean id="accessApprovalManager" class="org.sagebionetworks.repo.manager.AccessApprovalManagerImpl" />

	<bean id="amazonClientFactory" class="org.sagebionetworks.repo.util.AmazonClientFactoryImpl"
		scope="singleton" />

	<bean id="userManager" class="org.sagebionetworks.repo.manager.UserManagerImpl" />

	<bean id="userDAO" class="org.sagebionetworks.repo.util.UserDAOProxy"
		scope="singleton" />
	<bean id="userDAOImpl" class="org.sagebionetworks.authutil.CrowdUserDAO"
		scope="singleton" />

	<bean id="backupManager"
		class="org.sagebionetworks.repo.manager.backup.NodeBackupManagerImpl"
		scope="singleton" />

	<bean id="nodeOwnerMigrator"
		class="org.sagebionetworks.repo.manager.backup.migration.NodeOwnerMigratorImpl"
		scope="singleton" />

	<bean id="migrationDriver"
		class="org.sagebionetworks.repo.manager.backup.migration.MigrationDriverImpl"
		scope="singleton">
		<property name="revisionSteps">
			<list>
				<bean
					class="org.sagebionetworks.repo.manager.backup.migration.ApplyMigrationData">
					<constructor-arg>
						<bean
							class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
							<property name="targetClass">
								<value>org.sagebionetworks.repo.model.registry.MigrationDataLoaderImpl
								</value>
							</property>
							<property name="targetMethod">
								<value>getMigrationData</value>
							</property>
						</bean>
					</constructor-arg>
				</bean>
				<bean
					class="org.sagebionetworks.repo.manager.backup.migration.GenericMigrator">
					<constructor-arg>
						<bean id="migrationSpecData"
							class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
							<property name="targetClass">
								<value>org.sagebionetworks.repo.model.registry.MigrationSpecDataLoaderImpl
								</value>
							</property>
							<property name="targetMethod">
								<value>getMigrationSpecData</value>
							</property>
						</bean>
					</constructor-arg>
				</bean>
				<bean
					class="org.sagebionetworks.repo.manager.backup.migration.DataTypeMigrator">
				</bean>
				<bean
					class="org.sagebionetworks.repo.manager.backup.migration.NodeOwnerMigratorImpl">
				</bean>
			</list>
		</property>
	</bean>
	
	<bean id="backupDriver" class="org.sagebionetworks.repo.manager.backup.daemon.BackupDriverImpl" scope="singleton"/>
	
	<bean id="migrationManager" class="org.sagebionetworks.repo.manager.migration.MigrationManagerImpl" scope="singleton">
		<property name="backupBatchMax"
			ref="stackConfiguration.migrationBackupBatchMax" />
	</bean>

	<bean id="nodeSerializer"
		class="org.sagebionetworks.repo.manager.backup.NodeSerializerImpl"
		scope="singleton" />

	<bean id="entityBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.NodeBackupDriverImpl"
		scope="singleton" />

	<bean id="principalBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.PrincipalBackupDriver"
		scope="singleton" />

	<!-- This needs to be converted to GenericBackupDriverImpl.  Do not copy this pattern. -->
	<bean id="accessRequirementBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.AccessRequirementBackupDriver"
		scope="singleton" />
		
	<!-- This needs to be converted to GenericBackupDriverImpl.  Do not copy this pattern. -->
	<bean id="activityBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.ActivityBackupDriver"
		scope="singleton" />

	<!-- This needs to be converted to GenericBackupDriverImpl.  Do not copy this pattern. -->
	<bean id="evaluationBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.EvaluationBackupDriver"
		scope="singleton" />
	
	<!-- This needs to be converted to GenericBackupDriverImpl.  Do not copy this pattern. -->
	<bean id="submissionBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.SubmissionBackupDriver"
		scope="singleton" />

	<!-- This needs to be converted to GenericBackupDriverImpl.  Do not copy this pattern. -->
	<bean id="trashCanBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.TrashCanBackupDriver"
		scope="singleton" />
	
	<!-- This needs to be converted to GenericBackupDriverImpl.  Do not copy this pattern. -->
	<bean id="favoriteBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.FavoriteBackupDriver"
		scope="singleton" />
		
	<bean id="fileHandleBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.GenericBackupDriverImpl">
		<constructor-arg>
			<bean id="fileHandleMigratableManager" class="org.sagebionetworks.repo.manager.backup.FileHandleMigratableManager" />
		</constructor-arg>
	</bean>

	<bean id="wikiPageBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.GenericBackupDriverImpl">
		<constructor-arg>
			<bean id="wikiPageMigratableManager" class="org.sagebionetworks.repo.manager.backup.WikiPageMigratableManager" />
		</constructor-arg>
	</bean>

	<bean id="doiBackupDriver"
		class="org.sagebionetworks.repo.manager.backup.GenericBackupDriverImpl">
		<constructor-arg>
			<bean id="doiMigratableManager" class="org.sagebionetworks.repo.manager.backup.DoiMigratableManager" />
		</constructor-arg>
	</bean>

	<bean id="stackStatusManager" class="org.sagebionetworks.repo.manager.StackStatusManagerImpl"
		scope="singleton" />

	<bean id="conceptCache"
		class="org.sagebionetworks.repo.manager.ontology.ConceptCacheLocalImpl"
		scope="singleton" />

	<bean id="conceptManager"
		class="org.sagebionetworks.repo.manager.ontology.ConceptManagerImpl"
		scope="singleton" />

	<bean id="s3TokenManager" class="org.sagebionetworks.repo.manager.S3TokenManagerImpl"
		scope="singleton" />

	<bean id="s3Utility" class="org.sagebionetworks.repo.manager.AmazonS3UtilityImpl"
		scope="singleton" />

	<bean id="storageUsageManager"
		class="org.sagebionetworks.repo.manager.StorageUsageManagerImpl"
		scope="singleton" />

	<bean id="attachmentManager" class="org.sagebionetworks.repo.manager.AttachmentManagerImpl"
		scope="singleton" />

	<bean id="schemaManager" class="org.sagebionetworks.repo.manager.SchemaManagerImpl"
		scope="singleton" />
		
	<bean id="evaluationManager" class="org.sagebionetworks.evaluation.manager.EvaluationManagerImpl" 
		scope="singleton" />
		
	<bean id="participantManager" class="org.sagebionetworks.evaluation.manager.ParticipantManagerImpl" 
		scope="singleton" />
		
	<bean id="submissionManager" class="org.sagebionetworks.evaluation.manager.SubmissionManagerImpl" 
		scope="singleton" />
	
	<bean id="wikiManager" class="org.sagebionetworks.repo.manager.wiki.WikiManagerImpl" 
		scope="singleton" />

	<bean id="entityDoiManager" class="org.sagebionetworks.repo.manager.doi.EntityDoiManagerImpl" 
		scope="singleton" />

	<bean id="doiAdminManager" class="org.sagebionetworks.repo.manager.doi.DoiAdminManagerImpl" 
		scope="singleton" />

	<bean id="dynamoAdminManager" class="org.sagebionetworks.repo.manager.dynamo.DynamoAdminManagerImpl" 
		scope="singleton" />

	<bean id="nodeTreeQueryManager" class="org.sagebionetworks.repo.manager.dynamo.NodeTreeQueryManagerImpl"
		scope="singleton" />

	<!-- The thread pool used by the backup/restore daemons -->
	<bean id="backupDaemonThreadPool"
		class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetClass">
			<value>java.util.concurrent.Executors</value>
		</property>
		<property name="targetMethod">
			<value>newFixedThreadPool</value>
		</property>
		<property name="arguments"
			ref="stackConfiguration.backupRestoreThreadPoolMaximum" />
	</bean>

	<!-- The second thread pool used by the backup/restore daemons -->
	<bean id="backupDaemonThreadPool2"
		class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetClass">
			<value>java.util.concurrent.Executors</value>
		</property>
		<property name="targetMethod">
			<value>newFixedThreadPool</value>
		</property>
		<property name="arguments"
			ref="stackConfiguration.backupRestoreThreadPoolMaximum" />
	</bean>

	<bean id="backupDaemonLauncher"
		class="org.sagebionetworks.repo.manager.backup.daemon.BackupDaemonLauncherImpl"
		scope="singleton" >
		<!--  the keys in this map  match the enum MigratableObjectType.  The order of this map is not imporant. -->
		<property name="backupDriverMap">
			<map>
				<entry key="PRINCIPAL">
					<ref bean="principalBackupDriver" />
				</entry>
				<entry key="FILEHANDLE">
					<ref bean="fileHandleBackupDriver" />
				</entry>
				<entry key="WIKIPAGE">
					<ref bean="wikiPageBackupDriver" />
				</entry>				
				<entry key="ENTITY">
					<ref bean="entityBackupDriver" />
				</entry>
				<entry key="ACCESSREQUIREMENT">
					<ref bean="accessRequirementBackupDriver" />
				</entry>
				<entry key="ACTIVITY">
					<ref bean="activityBackupDriver" />
				</entry>
				<entry key="EVALUATION">
					<ref bean="evaluationBackupDriver" />
				</entry>
				<entry key="SUBMISSION">
					<ref bean="submissionBackupDriver" />
				</entry>
				<entry key="TRASHED_ENTITY">
					<ref bean="trashCanBackupDriver" />
				</entry>
				<entry key="FAVORITE">
					<ref bean="favoriteBackupDriver" />
				</entry>
				<entry key="DOI">
					<ref bean="doiBackupDriver" />
				</entry>
			</map>
		</property>
	</bean>

	<!-- A manager that returns all system objects and their dependencies. -->
	<bean id="dependencyManager" class="org.sagebionetworks.repo.manager.backup.migration.DependencyManagerImpl" init-method="init">
		<property name="migratableDaos">
		<!-- Note: The order of this list determines the order of data migration. 
		     The order must also match the order of the types in the MigratableObjectType enum.  -->
			<list>
				<ref bean="userGroupDAO"/>
				<ref bean="fileHandleDao"/>
				<ref bean="wikiPageDAO"/>
				<ref bean="activityDao"/>
				<ref bean="nodeDao"/>
				<ref bean="accessRequirementDAO"/>
				<ref bean="evaluationDAO"/>
				<ref bean="submissionStatusDAO"/>
				<ref bean="trashCanBackupDao"/>
				<ref bean="favoriteDao"/>
				<ref bean="doiMigratableDao"/>
			</list>
		</property>
	</bean>
	
		<!-- Used to read document from repo -->
	<bean id="searchDocumentDriver"
		class="org.sagebionetworks.repo.manager.search.SearchDocumentDriverImpl"
		scope="singleton" />

</beans>
